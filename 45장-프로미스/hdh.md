# 45장 프로미스

### 1. 비동기 처리를 위한 콜백 패턴의 단점

1. 콜백 헬
   - 비동기 함수의 비동기 처리 결과를 외부에 반환할 수 없다.
   - 비동기 함수는 비동기 처리 결과에 따른 후속 처리를 수행하는 콜백 함수를 전달하여 처리하는 것이 일반적이다.
   - 비동기 처리 결과를 가지고 또다시 비동기 함수를 호출해야 하는 경우 호출이 중첩되어 복잡도가 높아지는데 이를 **콜백 헬**이라 한다.
2. 에러 처리의 한계

### 2. 프로미스의 생성

- Promise 생성자 함수를 new 연산자와 함께 호출하면 프로미스를 생성한다.
- Promise 생성자 함수는 비동기 처리를 수행할 콜백 함수를 인수로 전달 받고 이 콜백 함수는 resolve와 reject 함수를 인수로 전달받는다.
- 프로미스는 현재 비동기 처리가 어떻게 진행되고 있는지를 나타내는 상태 정보를 갖는다.
  | 프로미스의 상태 정보 | 의미 | 상태 변경 조건 |
  | -------------------- | ------------------------------------- | -------------------------------- |
  | pending | 비동기 처리가 아직 수행되지 않은 상태 | 프로미스가 생성된 직후 기본 상태 |
  | fulfilled | 비동기 처리가 수행된 상태(성공) | resolve 함수 호출 |
  | rejected | 비동기 처리가 수행된 상태(실패) | reject 함수 호출 |
- 생성된 직후 프로미스는 기본적으로 pending, 이후 처리 결과에 따라 resolve/reject 함수를 호출하여 프로미스를 fulfilled/rejected 상태(settled)로 변경한다.
- 프로미스는 비동기 처리 상태와 처리 결과를 관리하는 객체다.

### 3. 프로미스의 후속 처리 메서드

- 프로미스의 비동기 처리 상태 변화에 따른 후속 처리를 위해 프로미스가 제공하는 메서드로 then, catch, finally가 있다.
- 모든 후속 처리 메서드는 프로미스를 반환하고 비동기로 동작한다.

#### 3.1 Promise.prototype.then

- then 메서드는 두 개의 콜백 함수를 인수로 전달 받는다.
- 첫 번째 콜백 함수는 프로미스가 fulfilled 상태가 되면 호출되고 콜백 함수는 비동기 처리 결과를 인수로 전달받는다.
- 두 번째 콜백 함수는 프로미스가 rejected 상태가 되면 호출되고 콜백 함수는 에러를 인수로 전달받는다.
- then 메서드는 언제나 프로미스를 반환한다. 프로미스가 아닌 값을 반환하면 암묵적으로 resolve/rejected하여 프로미스를 생성해 반환한다.

#### 3.2 Promise.prototype.catch

- catch 메서드는 한 개의 콜백 함수를 인수로 전달받는다.
- 콜백 함수는 프로미스가 rejected 상태인 경우에만 호출되며 then과 마찬가지로 언제나 프로미스를 반환한다.

#### 3.3 Promise.prototype.finally

- finally 메서드는 한 개의 콜백 함수를 인수로 전달받는다.
- 프로미스의 성공, 실패와 상관 없이 무조건 한 번 호출된다.
- 다른 후속 처리 메서드와 마찬가지로 언제나 프로미스를 반환한다.

### 4. 프로미스의 에러 처리

- 프로미스의 에러 처리는 후속 처리 메서드 then의 두 번째 콜백 함수로 또는 catch 메서드로 처리할 수 있다.
- then 메서드의 두 번째 콜백 함수는 첫 번째 콜백 함수에서 발생한 에러를 캐치하지 못하고 코드가 복잡해져서 가독성이 좋지 않다.
- 따라서 에러 처리는 then 메서드가 아닌 catch 메서드에서 하는 것을 권장한다.

### 5. 프로미스 체이닝

- 프로미스 후속 처리 메서드는 언제나 프로미스를 반환하므로 연속적으로 호출할 수 있는데 이를 **프로미스 체이닝**이라 한다.
- 프로미스 체이닝을 사용하면 콜백 헬이 발생하지 않는다. 하지만 프로미스도 콜백 패턴을 사용하며 콜백 패턴은 가독성이 좋지 않다.
- ES8에서 도입된 async/await을 사용하면 프로미스의 후속 처리 메서드 없이 프로미스가 처리 결과를 반환하도록 구현할 수 있다.

### 6. 프로미스의 정적 메서드

- Promise는 객체로 5가지 정적 메서드를 제공한다.

#### 6.1 Promise.resolve/Promise.reject

- 이미 존재하는 값을 래핑하여 프로미스를 생성하기 위해 사용
- 인수로 전달 받은 값을 resolve/reject하는 프로미스를 생성한다.

##### 6.2 Promise.all

##### 6.3 Promise.race

##### 6.4 Promise.allSettled

### 7. 마이크로태스크 큐

- 태스크 큐와는 별도의 큐로 프로미스 후속 처리 메서드의 콜백 함수가 일시 저장된다. 그 외의 비동기 함수의 콜백 함수나 이벤트 핸들러는 태스크 큐에 일시 저장된다.
- 마이크로태스크 큐는 우선 순위가 태스크 큐보다 높다. 즉, 이벤트 루프는 콜스택이 비면 마이크로태스크 큐에서 대기 중인 함수를 가져와 실행하고 마이크로태스크 큐가 비면 태스크 큐에서 대기 중인 함수를 가져와 실행한다.

### 8. fetch

- fetch는 XMLHttpRequest 객체와 마찬가지로 HTTP 요청 전송 기능을 제공하는 클라이언트 사이드 Web API다.
- XMLHttpRequest 객체보다 사용법이 간단하고 프로미스를 지원하며 IE를 제외한 대부분의 모던 브라우저에서 제공한다.
- fetch 함수에는 HTTP 요청을 전송할 URL과 요청 메서드, 헤더, 페이로드 등을 설정한 객체를 전달한다.
- HTTP 응답을 나타내는 response 객체를 래핑한 Promise 객체를 반환한다.
